jQuery.noConflict();

(function ($) {

  function updateOnlineCount() {
    $('#chat_widget_counter').html($('.chat_widget_member').length);
  }
  $("#user_list").on("click", '.send_mail', function () {
    var data = [];
    var post_data = {};
    var $this = $(this);
    var parent_tr = $this.closest('td').parent('tr');
    parent_tr.addClass("highlite");
    $(parent_tr).find('td').each(function () {
      data.push($(this).find('input').val());
    });
    data.splice(-1, 1);
    post_data.name = data[0];
    post_data.email = data[1];
    post_data.task_id = data[2];
    post_data.user_id = data[3];
    post_data.client_id = data[4];
    post_data.added_datetime = data[5]
    toastr.success('email sent');
    toastr.options = {
      "closeButton": false,
      "debug": false,
      "positionClass": "toast-top-right",
      "onclick": null,
      "showDuration": "300",
      "hideDuration": "1000",
      "timeOut": "5000",
      "extendedTimeOut": "1000",
      "showEasing": "swing",
      "hideEasing": "linear",
      "showMethod": "fadeIn",
      "hideMethod": "fadeOut"
    }
    $.post("/welcome/queue", post_data)
    .done(function (data) {});
  });

$("#add_user").on("click", function () {
  var $tableBody = $('#user_list').find("tbody"),
  $trLast = $tableBody.find("tr:last"),
  $trNew = $trLast.clone();
  $trLast.after($trNew);
});

$('#chat_widget_login_button').click(function() {

  $(this).hide(); 
  $('#chat_widget_login_loader').show();
  username = $('#chat_widget_username').val();
  username = username.replace(/[^a-z0-9]/gi, '');
  
  if( username == '' ) {
    alert('Please provide a valid username (alphanumeric only)');
  } else {
    ajaxCall('/pusherchat/session', { username : username }, function() {
      pusher = new Pusher('dd7bae8d4eea81d560ec');
      Pusher.channel_auth_endpoint = '/pusherchat/auth';
      chat_channel = pusher.subscribe('presence-pusher_chat');

      pusher.connection.bind('connected', function() {
        $('#chat_widget_login_loader').hide();
        $('#chat_widget_login_button').show();

        $('#chat_widget_login').hide();
        $('#chat_widget_main_container').show();

        chat_channel.bind('pusher:subscription_succeeded', function(members) {
          var whosonline_html = '';
          members.each(function(member) {
            whosonline_html += '<li class="chat_widget_member" id="chat_widget_member_' + 
            member.id + '">' + member.info.username + '</li>';
          });
          $('#chat_widget_online_list').html(whosonline_html);
          updateOnlineCount();
        });

        chat_channel.bind('pusher:member_added', function(member) {
          $('#chat_widget_online_list').append('<li class="chat_widget_member" ' +
            'id="chat_widget_member_' + member.id + '">' + member.info.username + '</li>');
          updateOnlineCount();
        });

        chat_channel.bind('pusher:member_removed', function(member) {
          $('#chat_widget_member_' + member.id).remove();
            updateOnlineCount();
          });
        });          
      });
    }
  });

  function ajaxCall(ajax_url, ajax_data, successCallback) {
    $.ajax({
      type : "POST",
      url : ajax_url,
      dataType : "json",
      data: ajax_data,
      time : 10,
      success : function(msg) {
        if( msg.success ) {
          successCallback(msg);
        } else {
          alert(msg.errormsg);
        }
      },
      error: function(msg) {
      }
    });
  }

/*
* se
*/

})(jQuery);